<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Pong?</title>
    </head>
    <body>
        <script src="/socket.io/socket.io.js"></script>
        <script src="https://koda.nu/simple.js">
            var socket = io();

            game = new Game();

            socket.on("sync", (msg) => {
                game.ball.xSpeed = msg.bxs * game.resolution.x;
                game.ball.ySpeed = msg.bys * game.resolution.y;
                game.player1.speed = msg.ps * game.resolution.y;
                game.player2.speed = msg.os * game.resolution.y;
                game.player1.height = msg.h * game.resolution.y;
                game.player1.width = msg.w * game.resolution.x;
                game.player2.height = msg.h * game.resolution.y;
                game.player2.width = msg.w * game.resolution.x;
            })

            socket.on("ballUpdate", (msg) => {
                game.ball.xSpeed = msg.xs * game.resolution.x;
                game.ball.ySpeed = msg.ys * game.resolution.y;
            });

            socket.on("posUpdate", (msg) => {
                game.player1.x = msg.px * game.resolution.x;
                game.player1.y = msg.py * game.resolution.y;
                game.player2.x = msg.ox * game.resolution.x;
                game.player2.y = msg.oy * game.resolution.y;
                game.ball.x = msg.bx * game.resolution.x;
                game.ball.y = msg.by * game.resolution.y;
            });

            function Ball(game) {
                this.game = game;
                this.x = 0;
                this.y = 0;
                this.r = 10;
                this.xSpeed = 566;
                this.ySpeed = 400;

                this.lastUpdate = Date.now();

                this.update = function() {
                    let now = Date.now();
                    let dt = (now - this.lastUpdate)/1000;
                    this.lastUpdate = now;

                    // Clientside hit decection, is buggy

                    // if (this.y < this.r) {
                    //     this.y = this.r;
                    //     this.ySpeed *= -1;
                    // } else if (this.y > 1080 - this.r) {
                    //     this.y = 1080 - this.r;
                    //     this.ySpeed *= -1;
                    // }

                    // if (this.x < game.player1.width + this.r && this.y > game.player1.y - this.r && this.y < game.player1.y + game.player1.height + this.r && this.x > game.player1.x + game.player1.width) {
                    //     this.x = this.r + game.player1.width;
                    //     this.xSpeed *= -1;
                    // } else if (this.x > game.player2.x - this.r && this.y > game.player2.y - this.r && this.y < game.player2.y + game.player2.height + this.r && this.x > game.player2.x + game.player2.width) {
                    //     this.x = game.player2.x - this.r;
                    //     this.xSpeed *= -1;
                    // }

                    this.x += this.xSpeed * dt;
                    this.y += this.ySpeed * dt;

                    circle(this.x, this.y, this.r, "black");
                }
            }

            function Paddle(game) {
                this.direction = 0;
                this.width = 20;
                this.height = 200;
                this.game = game;
                this.speed = 600;
                this.x = 0;
                this.y = 0;

                this.lastUpdate = Date.now();

                this.update = function() {
                    let now = Date.now();
                    let dt = (now - this.lastUpdate)/1000;
                    this.lastUpdate = now;

                    if (this.y + this.direction * dt * this.speed <= this.game.resolution.y - this.height && this.y + this.direction * dt * this.speed >= 0) {
                        this.y += this.direction * dt * this.speed;
                    } else if (this.y + this.direction * dt * this.speed <= this.game.resolution.y - this.height) {
                        this.y = 0;
                    } else if (this.y + this.direction * dt * this.speed >= 0) {
                        this.y = this.game.resolution.y - this.height;
                    }
                    rectangle(this.x, this.y, this.width, this.height, "black");
                }
            }
            
            function Game() {
                this.resolution = {x: totalWidth, y: totalHeight}
                this.player1 = new Paddle(this);
                this.player2 = new Paddle(this);
                this.player2.x = this.resolution.x - this.player2.width;
                this.ball = new Ball(this);

                this.update = function() {
                    rectangle(0, 0, totalWidth, totalHeight, "white");
                    this.player1.update();
                    this.player2.update();
                    this.ball.update(this);
                };
            }

            updatesPerSecond = 60;
            function update() {
                if (!keyboard.down && !keyboard.up || keyboard.down && keyboard.up) {
                    game.player1.direction = 0;
                    socket.emit("input", 0);
                } else if (keyboard.up) {
                    game.player1.direction = -1;
                    socket.emit("input", -1);
                } else if (keyboard.down) {
                    game.player1.direction = 1;
                    socket.emit("input", 1);
                }

                game.update();
            }
        </script>
    </body>
</html>