<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Pong?</title>
    </head>
    <body>
        <script src="/socket.io/socket.io.js"></script>
        <script src="https://koda.nu/simple.js">
            var socket = io();
            var game = 0;
            // Change game state to end if the game ends
            socket.on("end", (msg) => {
                console.log(msg);
                state = "end";
            });

            // Set initial game data
            socket.on("start", (msg) => {
                state = "start";
                game = new Game(msg);
                game.draw();
            });

            // Update game data to be the same as servers
            socket.on("data", (data) => {
                player.x = data.p.x * totalWidth;
                player.y = data.p.y * totalHeight;

                opponent.x = data.o.x * totalWidth;
                opponent.y = data.o.y * totalHeight;

                ball.x = data.ball.x * totalWidth;
                ball.y = data.ball.y * totalHeight;

                game.draw();
            });

            // Keep track of game state
            var state = "waiting";
            
            function Game(msg) {
                this.player = new Player(msg.p.x * totalWidth, msg.p.y * totalHeight);
                this.player.paddle.width = msg.p.w * totalWidth;
                this.player.paddle.height = msg.p.h * totalHeight;

                this.opponent = new Player(msg.o.x * totalWidth, msg.o.y * totalHeight);
                this.opponent.paddle.width = msg.o.w * totalWidth;
                this.opponent.paddle.height = msg.o.h * totalHeight;

                this.ball = new Ball(msg.ball.x * totalWidth, msg.ball.y * totalHeight, msg.ball.r * totalWidth)

                this.update = function() {
                    this.draw();
                }

                this.draw = function() {
                    rectangle(0, 0, totalWidth, totalHeight, "white");
                    this.player.draw();
                    this.opponent.draw();
                    this.ball.draw();
                }

                setInterval(() => {
                    socket.emit("data", game.player.paddle.y/totalHeight);
                }, 50);
            }

            function Player(x, y) {
                this.paddle = new Paddle(x, y);
                this.points = 0;

                this.draw = function() {
                    this.paddle.draw();
                }
            }

            function Paddle(x, y) {
                this.x = x;
                this.y = y;
                this.width = 0;
                this.height = 0;

                this.draw = function() {
                    rectangle(this.x, this.y, this.width, this.height, "black")
                }
            }

            function Ball(x, y, r) {
                this.x = x;
                this.y = y;
                this.r = r;

                this.draw = function() {
                    circle(this.x, this.y, this.r, "black")
                }
            }

            function update() {
                // Move paddle if keys are being pressed
                if (state === "start") {
                    if (keyboard.up) {
                        game.player.paddle.y -= 10;
                    }
    
                    if (keyboard.down) {
                        game.player.paddle.y += 10;
                    }
                }
            }

        </script>
    </body>
</html>